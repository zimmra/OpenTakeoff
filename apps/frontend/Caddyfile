:80 {
    # API Reverse Proxy
    # Must come before wildcard catch-all to prevent try_files from intercepting
    handle /api/* {
        reverse_proxy opentakeoff-backend:3001
    }

    # Static File Server & SPA Fallback
    handle {
        root * /srv
        encode gzip zstd
        file_server
        try_files {path} /index.html
    }

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Cache control for static assets
    @static {
        path *.js *.css *.woff *.woff2 *.ttf *.eot *.ico *.svg *.png *.jpg *.jpeg *.gif *.webp
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # No cache for HTML
    @html {
        path *.html /
    }
    header @html Cache-Control "no-cache, no-store, must-revalidate"
}

